testinfo:
    summary: 'Test autopatch for dialtone and congestion'
    description: |
        'See app_rpt issue #725'

test-modules:
    test-object:
        config-section: test-object-config
        typename: 'test_case.TestCaseModule'
    modules:
        -
            config-section: timer-originator
            typename: 'pluggable_modules.Originator'
        -
            config-section: hangup-monitor
            typename: 'pluggable_modules.HangupMonitor'
        -
            config-section: ami-config
            typename: 'pluggable_modules.EventActionModule'
 
test-object-config:
    connect-ami: True
    reactor-timeout: 30
    stop-after-scenarios: False

timer-originator:
    channel: 'Local/s@wait'
    context: 'timer'
    exten: 'patch'
    priority: '1'
    trigger: 'ami_connect'

hangup-monitor:
    ids: '0'

ami-config:
    -
        ami-events:
            conditions:
                match:
                    Event: 'UserEvent'
                    UserEvent: 'nodestart'
        ami-actions:
            action:
                Action: 'Command'
                Command: 'rpt fun 123 *61'
    -
        ami-events:
            conditions:
                Event: 'UserEvent'
                UserEvent: 'dialtone'
            count: 1
    -
        ami-events:
            conditions:
                Event: 'UserEvent'
                UserEvent: 'congestion'
            count: 1

        ami-actions:
            action:
                Action: 'Command'
                Command: 'rpt fun 123 *62'

properties:
    tags:
        - dial
        - apps
    dependencies:
        - python: 'twisted'
        - python: 'starpy'
        - asterisk: 'app_dial'
        - asterisk: 'app_userevent'
        - asterisk: 'app_originate'
        - asterisk: 'app_rpt'
        - asterisk: 'chan_iax2'
        - asterisk: 'pbx_config'

